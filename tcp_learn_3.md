#图解TCP/IP分层与数据在网络中的传送 (3)

## 不同子网间的数据发送是如何封装和解封装的

A和B在不同的子网，中间通过两个路由器相连，A的IP地址是10.0.0.2，MAC地址是M1，B的IP地址是12.0.0.2，MAC地址是M6，中间两个路由器的各个端口的IP地址和MAC地址见图所示。

![Alt text](https://github.com/carrier001/blog/blob/master/route1.png "") 

1. A计算机首先判断B计算机的IP地址和自己的IP地址是否在一个网段，即网络部分是否相同，本例不在一个网段，则数据包应该发送给Router1，再由Router1转发。
2. 计算机A配置了网关10.0.0.1（实际就是Router1和子网10.0.0.X相连的接口的IP地址），A计算机发出去的数据帧源IP地址为10.0.0.2，目标IP地址为12.0.0.2，源MAC地址为M1，目标MAC地址为3. （注意：源IP和目的IP就是对应A和B的IP地址，但源MAC和目的MAC分别为A的MAC地址M1和网关的MAC地址M2）。这样交换机SW1将会根据MAC地址表将数据帧转发到路由器Router1的接口。A计算机发出后到Router1接收前的数据帧见上图的标识1部分。
3. 路由器Router1查看数据包的目标IP地址，根据路由表，决定数据包下一跳应该发往何处。本示例Router1将数据包转发到Router2。 Router1将数据帧的目标MAC地址更改为M4，源MAC地址更改为M3（注意：源IP和目的IP未改变），这样Router2就能接收该数据帧。Router1发出后到Router2接收前的数据帧见上图的标识2部分。（路由器的路由表等原理可以参见沈庆辰大师主讲的<IP路由介绍>）
4. 同样路由器Router2接收到数据帧后，查看数据包的目标IP地址，根据路由表转发，数据帧的源MAC地址更改为M5，目标MAC地址更改为M6（注意：源IP和目的IP还是未改变）。这样数据帧就能够被交换机SW2转发到计算机B。Router2发出后到B接收前的数据帧见上图的标识3部分。
5. 回顾上次的“一个比较弱智的思考题：交换机为什么没有和路由器一样，在转发端口需要配置IP地址？甚至MAC地址都不需要配置啊？”，分析了不同子网从A发到B数据发送过程就应该很清楚了吧

看了上面的过程，再看看下图数据包在A、router1、router2、B的封装和解封，注意看数据帧在同一个子网内是相同的，而在不同的子网间是不同的，是不是也很好理解啊

![Alt text](https://github.com/carrier001/blog/blob/master/tran.png "") 

最后，小哥再做个小结作为结束哈
* 在网络中的分组（源IP、目的IP、源端口号、目的端口号）在网络中传输是一直不变的，哪怕经过不同路由器的转发（实际就是跨越不同子网嘛），所以又说传输层协议是端到端的协议
* 数据帧的目标MAC地址和源MAC地址经过不同子网时是变化的，即MAC地址只供一个子网内寻址物理地址，所以有说数据链路层协议是点到点的协议。
* MAC地址决定了数据帧下一跳哪个设备接收，而IP地址决定了数据包的起点和终点。
* 交换机基于数据帧的MAC地址转发数据帧，路由器基于数据包的IP地址转发数据包。
  Over，多谢观赏！:laughing:	
